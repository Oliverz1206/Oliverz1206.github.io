{% assign TOTAL_SIZE = 3 %}

{% assign TAG_SCORE = 1 %}

{% assign CATEGORY_SCORE = 0.5 %}

{% assign SEPARATOR = ':' %}

{%- comment -%} 取顶级类目（categories[0]），若不存在则退化为全站 {%- endcomment -%}
{% assign top = page.categories | first %}
{% if top %}
  {% assign pool = site.categories[top] %}
{% else %}
  {% assign pool = site.posts %}
{% endif %}

{%- comment -%} 去掉当前页面自身 {%- endcomment -%}
{% assign pool = pool | where_exp: 'p', 'p.url != page.url' %}

{% assign score_list = '' | split: '' %}
{% for post in pool %}
  {% assign score = 0 %}

  {% if post.tags and page.tags %}
    {% for tag in post.tags %}
      {% if page.tags contains tag %}
        {% assign score = score | plus: TAG_SCORE %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if post.categories and page.categories %}
    {% for cat in post.categories offset:1 %}
      {% if page.categories contains cat %}
        {% assign score = score | plus: CATEGORY_SCORE %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if score > 0 %}
    {% capture item %}{{ score }}{{ SEPARATOR }}{{ forloop.index0 }}{% endcapture %}
    {% assign score_list = score_list | push: item %}
  {% endif %}
{% endfor %}

{%- comment -%} 取分数最高的 TOTAL_SIZE 篇 {%- endcomment -%}
{% assign relate_posts = '' | split: '' %}
{% if score_list.size > 0 %}
  {% assign score_list = score_list | sort | reverse %}
  {% for entry in score_list limit: TOTAL_SIZE %}
    {% assign idx = entry | split: SEPARATOR | last | to_integer %}
    {% assign relate_posts = relate_posts | push: pool[idx] %}
  {% endfor %}
{% endif %}

{% if relate_posts.size > 0 %}
  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">
      {{- site.data.locales[include.lang].post.relate_posts -}}
    </h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      {% for post in relate_posts %}
        <article class="col">
          <a href="{{ post.url | relative_url }}" class="post-preview card h-100">
            <div class="card-body">
              {% include datetime.html date=post.date lang=include.lang %}
              <h4 class="pt-0 my-2">{{ post.title }}</h4>
              <div class="text-muted">
                <p>{% include post-description.html %}</p>
              </div>
            </div>
          </a>
        </article>
      {% endfor %}
    </nav>
  </aside>
{% endif %}
