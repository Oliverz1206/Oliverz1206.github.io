---
layout: page
# Hierarchical list layout
---

{% include lang.html %}
{% assign top = page.top | default: page.title %}

<article class="mb-4">
  {{ content }}
</article>

<!-- 根容器，脚本按此作用域工作 -->
<div data-lists>
  {% assign group_index = 0 %}

  {%- comment -%} 顶层分类匹配（categories[0] == top） {%- endcomment -%}
  {% assign posts_all = site.posts | where_exp: "post", "post.categories and post.categories[0] == top" %}

  {%- comment -%} 一级分类（categories[1]）去重并排序 {%- endcomment -%}
  {% assign l1_all = "" | split: "" %}
  {% for post in posts_all %}
    {% assign l1 = post.categories[1] %}
    {% if l1 and l1_all contains l1 %}
    {% elsif l1 %}
      {% assign l1_all = l1_all | push: l1 %}
    {% endif %}
  {% endfor %}
  {% assign l1_all = l1_all | sort %}

  {% for l1 in l1_all %}
    {% assign sub_posts = posts_all | where_exp: "p", "p.categories[1] == l1" %}

    {%- comment -%} 二级分类（categories[2]）去重并排序 {%- endcomment -%}
    {% assign l2_all = "" | split: "" %}
    {% for p in sub_posts %}
      {% assign l2 = p.categories[2] %}
      {% if l2 and l2_all contains l2 %}
      {% elsif l2 %}
        {% assign l2_all = l2_all | push: l2 %}
      {% endif %}
    {% endfor %}
    {% assign l2_all = l2_all | sort %}

    {% capture _l1_url %}/{{ top | slugify | url_encode }}/{{ l1 | slugify | url_encode }}/{% endcapture %}
    {% assign l1_collapse_id = "L1-" | append: group_index %}
    {% assign group_index = group_index | plus: 1 %}

    <div class="card categories mb-3" data-level="l1">
      <!-- 行级触发器：用 data-collapse（由 JS 调用 Bootstrap API 切换） -->
      <div class="card-header d-flex align-items-center justify-content-between l1-row"
           role="button" tabindex="0"
           data-collapse="#{{ l1_collapse_id }}"
           aria-controls="{{ l1_collapse_id }}"
           aria-expanded="true">
        <div class="d-flex align-items-center">
          <i class="far fa-folder l1-folder-icon me-3"></i>
          <!-- 文字链接：正常跳转；JS 会 stopPropagation，避免触发行折叠 -->
          <a href="{{ _l1_url | relative_url }}"
             class="l1-link text-decoration-none me-2"
             data-no-collapse>{{ l1 }}</a>
          <span class="text-muted small">
            {% if l2_all.size > 0 %}{{ l2_all.size }} categories,{% endif %}
            {{ sub_posts.size }} post{% if sub_posts.size > 1 %}s{% endif %}
          </span>
        </div>
        <i class="fas fa-angle-right fa-fw l1-chevron"></i>
      </div>

      <!-- L1 面板默认展开 -->
      <div id="{{ l1_collapse_id }}" class="collapse show">
        <ul class="list-group">

          {%- comment -%} 直接挂在 L1 的文章（无 L2） {%- endcomment -%}
          {% assign direct_posts = sub_posts | where_exp: "p", "p.categories.size < 3 or p.categories[2] == nil" %}
          {% for post in direct_posts %}
            <li class="list-group-item">
              <i class="far fa-file fa-fw"></i>
              <a href="{{ post.url | relative_url }}" class="mx-2" data-no-collapse>{{ post.title }}</a>
            </li>
          {% endfor %}

          {%- comment -%} L2 分类块 {%- endcomment -%}
          {% for l2 in l2_all %}
            {% assign posts_l2 = sub_posts | where_exp: "p", "p.categories[2] == l2" %}
            {% capture _l2_url %}/{{ top | slugify | url_encode }}/{{ l1 | slugify | url_encode }}/{{ l2 | slugify | url_encode }}/{% endcapture %}
            {% assign l2_collapse_id = "L2-" | append: group_index %}
            {% assign group_index = group_index | plus: 1 %}

            <li class="list-group-item">
              <!-- L2 默认收起：初始加 .collapsed（用于箭头方向） -->
              <div class="d-flex align-items-center w-100 l2-row collapsed"
                   role="button" tabindex="0"
                   data-collapse="#{{ l2_collapse_id }}"
                   aria-controls="{{ l2_collapse_id }}"
                   aria-expanded="false">
                <i class="fas fa-chevron-right fa-fw l2-chevron me-2"></i>
                <i class="far fa-folder l2-folder-icon me-3"></i>
                <a href="{{ _l2_url | relative_url }}"
                   class="l2-link text-decoration-none mx-1"
                   data-no-collapse>{{ l2 }}</a>
                <span class="text-muted small ms-auto">
                  {{ posts_l2.size }} post{% if posts_l2.size > 1 %}s{% endif %}
                </span>
              </div>

              <ul class="list-group ms-3 mt-2 collapse" id="{{ l2_collapse_id }}">
                {% for post in posts_l2 %}
                  <li class="list-group-item">
                    <i class="far fa-file fa-fw"></i>
                    <a href="{{ post.url | relative_url }}" class="mx-2" data-no-collapse>{{ post.title }}</a>
                  </li>
                {% endfor %}
              </ul>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endfor %}
</div>
